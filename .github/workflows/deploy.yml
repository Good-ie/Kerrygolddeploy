name: CI/CD Deploy

on:
  push:
    branches:
      - main  # Triggers when you push to the main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout the repository
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 3Ô∏è‚É£ Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      # 4Ô∏è‚É£ Debug EC2 Key Name (Check if the secret is accessible)
      - name: Debug EC2 Key Name
        run: echo "EC2_KEY_NAME=${{ secrets.EC2_KEY_NAME }}"

      # 5Ô∏è‚É£ Terraform Init (Initialize the Terraform environment)
      - name: Terraform Init
        run: terraform init
        working-directory: terraform

      # 6Ô∏è‚É£ Terraform Apply (Apply the Terraform configuration)
      - name: Terraform Apply
        run: terraform apply -auto-approve -var="key_name=${{ secrets.EC2_KEY_NAME }}"
        working-directory: terraform
      # 7Ô∏è‚É£ Read Terraform Outputs
      - name: Read Terraform Outputs
        id: tf_outputs
        run: |
          EC2_DNS=$(terraform output -raw ec2_public_ip)
          if [ -z "$EC2_HOST" ]; then
            echo "EC2 IP is not available or empty"
          else
            echo "EC2_HOST=$EC2_HOST" >> $GITHUB_ENV
          fi

          ECR_URL=$(terraform output -raw ecr_repository_url)
          if [ -z "$ECR_URL" ]; then
            echo "ECR URL is not available or empty"
          else
            echo "ECR_URL=$ECR_URL" >> $GITHUB_ENV
          fi

          AWS_REGION=$(terraform output -raw aws_region)
          if [ -z "$AWS_REGION" ]; then
            echo "AWS Region is not available or empty"
          else
            echo "AWS_REGION=$AWS_REGION" >> $GITHUB_ENV
          fi
        working-directory: terraform

      # 8Ô∏è‚É£ Login to Amazon ECR
      - name: Login to Amazon ECR
        run: |
          ECR_REGISTRY=$(echo $ECR_URL | cut -d'/' -f1)
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY  

    
      # 9Ô∏è‚É£ Build Docker Image (Build the Docker image)
      - name: Build Docker image
        run: docker build -t app .

      # üîü Tag Docker Image (Tag the built Docker image)
      - name: Tag Docker image
        run: docker tag app:latest $ECR_URL:latest

      # 1Ô∏è‚É£1Ô∏è‚É£ Push Docker Image to ECR (Push the image to ECR)
      - name: Push Docker image to ECR
        run: docker push $ECR_URL:latest

      # 1Ô∏è‚É£2Ô∏è‚É£ Deploy to EC2 (Deploy the Docker image to EC2)
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            docker pull ${{ env.ECR_URL }}:latest
            docker stop app || true
            docker rm app || true
            docker run -d --name app -p 80:80 ${{ env.ECR_URL }}:latest
